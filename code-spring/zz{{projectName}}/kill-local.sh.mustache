#!/bin/bash
#
# Local Development Shutdown Script
# Generated by Genesis3 for {{{projectName}}}
#
# This script stops all local development services:
# - Spring Boot backend
{{#hasFrontend}}
# - Frontend (if available)
{{/hasFrontend}}
{{#hasDatabase}}
# - PostgreSQL database (optional, via --all flag)
{{/hasDatabase}}
#
# Usage:
#   ./kill-local.sh         # Stop backend and frontend only
{{#hasDatabase}}
#   ./kill-local.sh --all   # Stop all services including database
{{/hasDatabase}}
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_NAME="{{{projectName}}}"

# Ports
BACKEND_PORT=8080
{{#hasFrontend}}
FRONTEND_PORT=5173
{{/hasFrontend}}
{{#hasDatabase}}
DB_PORT=5432
{{/hasDatabase}}

# PID file location
PID_DIR="$SCRIPT_DIR/.pids"
BACKEND_PID_FILE="$PID_DIR/backend.pid"
{{#hasFrontend}}
FRONTEND_PID_FILE="$PID_DIR/frontend.pid"
{{/hasFrontend}}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
    echo ""
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}========================================${NC}"
}

print_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Kill process by PID file
kill_by_pid_file() {
    local pid_file=$1
    local service_name=$2

    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if ps -p "$pid" > /dev/null 2>&1; then
            kill "$pid" 2>/dev/null && print_success "Stopped $service_name (PID: $pid)"
            rm -f "$pid_file"
        else
            print_warning "$service_name not running (stale PID file)"
            rm -f "$pid_file"
        fi
    else
        print_info "No PID file for $service_name"
    fi
}

# Kill process by port
kill_by_port() {
    local port=$1
    local service_name=$2

    local pids=$(lsof -ti ":$port" 2>/dev/null || true)

    if [ -n "$pids" ]; then
        for pid in $pids; do
            kill "$pid" 2>/dev/null && print_success "Stopped $service_name on port $port (PID: $pid)"
        done
    else
        print_info "$service_name not running on port $port"
    fi
}

# Stop backend
stop_backend() {
    print_info "Stopping backend..."

    # Try PID file first
    kill_by_pid_file "$BACKEND_PID_FILE" "Backend (from PID file)"

    # Also check port in case it was started manually
    kill_by_port $BACKEND_PORT "Backend"

    # Kill any remaining Gradle/Java processes for this project
    local gradle_pids=$(pgrep -f "gradle.*bootRun" 2>/dev/null || true)
    if [ -n "$gradle_pids" ]; then
        for pid in $gradle_pids; do
            kill "$pid" 2>/dev/null && print_success "Stopped Gradle process (PID: $pid)"
        done
    fi

    # Kill any remaining Spring Boot processes on the backend port
    local java_pids=$(pgrep -f "java.*$BACKEND_PORT" 2>/dev/null || true)
    if [ -n "$java_pids" ]; then
        for pid in $java_pids; do
            kill "$pid" 2>/dev/null && print_success "Stopped Java process (PID: $pid)"
        done
    fi
}

{{#hasFrontend}}
# Stop frontend
stop_frontend() {
    print_info "Stopping frontend..."

    # Try PID file first
    kill_by_pid_file "$FRONTEND_PID_FILE" "Frontend (from PID file)"

    # Also check port in case it was started manually
    kill_by_port $FRONTEND_PORT "Frontend"

    # Kill any remaining Vite/node processes on the frontend port
    local vite_pids=$(pgrep -f "vite.*$FRONTEND_PORT" 2>/dev/null || true)
    if [ -n "$vite_pids" ]; then
        for pid in $vite_pids; do
            kill "$pid" 2>/dev/null && print_success "Stopped Vite process (PID: $pid)"
        done
    fi
}
{{/hasFrontend}}

{{#hasDatabase}}
# Stop database
stop_database() {
    print_info "Stopping database..."

    if [ -f "$SCRIPT_DIR/docker-compose.yaml" ]; then
        (cd "$SCRIPT_DIR" && docker compose down 2>&1) && print_success "Stopped PostgreSQL container"
    else
        # Try to stop by port
        kill_by_port $DB_PORT "PostgreSQL"
    fi
}
{{/hasDatabase}}

# Clean up
cleanup() {
    # Remove empty PID directory
    if [ -d "$PID_DIR" ] && [ -z "$(ls -A "$PID_DIR" 2>/dev/null)" ]; then
        rmdir "$PID_DIR" 2>/dev/null || true
    fi
}

# Print summary
print_summary() {
    echo ""
    echo -e "${GREEN}All services stopped${NC}"
    echo ""

    # Check if anything is still running
    local still_running=false

    if lsof -ti ":$BACKEND_PORT" >/dev/null 2>&1; then
        print_warning "Something still running on port $BACKEND_PORT"
        still_running=true
    fi

{{#hasFrontend}}
    if lsof -ti ":$FRONTEND_PORT" >/dev/null 2>&1; then
        print_warning "Something still running on port $FRONTEND_PORT"
        still_running=true
    fi
{{/hasFrontend}}

    if [ "$still_running" = false ]; then
        print_success "All ports are free"
    fi
}

# Main execution
main() {
{{#hasDatabase}}
    local stop_db=false
{{/hasDatabase}}

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
{{#hasDatabase}}
            --all|-a)
                stop_db=true
                shift
                ;;
{{/hasDatabase}}
            --help|-h)
                echo "Usage: $0 [options]"
                echo ""
                echo "Options:"
{{#hasDatabase}}
                echo "  --all, -a   Stop all services including database"
{{/hasDatabase}}
                echo "  --help, -h  Show this help message"
                echo ""
                exit 0
                ;;
            *)
                print_error "Unknown option: $1"
                echo "Use --help for usage information"
                exit 1
                ;;
        esac
    done

    print_header "Stopping Local Development Services"

    stop_backend
{{#hasFrontend}}
    stop_frontend
{{/hasFrontend}}

{{#hasDatabase}}
    if [ "$stop_db" = true ]; then
        stop_database
    else
        print_info "Database left running (use --all to stop)"
    fi
{{/hasDatabase}}

    cleanup
    print_summary
}

main "$@"
