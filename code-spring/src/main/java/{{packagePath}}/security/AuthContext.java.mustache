package {{{javaPackageFull}}}.security;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;
import org.springframework.stereotype.Component;

import java.util.Collections;
import java.util.List;
import java.util.Optional;

/**
 * Unified authentication context utility.
 * Provides convenient access to current user's authentication details.
 */
@Component
public class AuthContext {

    /**
     * Get the current authenticated user's ID (subject claim from JWT)
     */
    public Optional<String> getCurrentUserId() {
        return getJwt().map(Jwt::getSubject);
    }

    /**
     * Get the current authenticated user's email
     */
    public Optional<String> getCurrentUserEmail() {
        return getJwt().map(jwt -> jwt.getClaimAsString("email"));
    }

    /**
     * Get the current user's scopes/permissions
     */
    @SuppressWarnings("unchecked")
    public List<String> getCurrentUserScopes() {
        return getJwt()
            .map(jwt -> {
                Object scopeClaim = jwt.getClaim("scope");
                if (scopeClaim instanceof String) {
                    return List.of(((String) scopeClaim).split(" "));
                } else if (scopeClaim instanceof List) {
                    return (List<String>) scopeClaim;
                }
                return Collections.<String>emptyList();
            })
            .orElse(Collections.emptyList());
    }

    /**
     * Check if current user has a specific scope
     */
    public boolean hasScope(String scope) {
        return getCurrentUserScopes().contains(scope);
    }

    /**
     * Get the tenant ID from JWT claims (for multi-tenant applications)
     */
    public Optional<String> getTenantId() {
        return getJwt()
            .map(jwt -> {
                // Try common claim names for tenant ID
                String tenantId = jwt.getClaimAsString("tenant_id");
                if (tenantId == null) {
                    tenantId = jwt.getClaimAsString("org_id");
                }
                if (tenantId == null) {
                    tenantId = jwt.getClaimAsString("organization_id");
                }
                return tenantId;
            });
    }

    /**
     * Get a custom claim from the JWT
     */
    public Optional<String> getClaim(String claimName) {
        return getJwt().map(jwt -> jwt.getClaimAsString(claimName));
    }

    /**
     * Check if there is an authenticated user
     */
    public boolean isAuthenticated() {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        return auth != null && auth.isAuthenticated() && !"anonymousUser".equals(auth.getPrincipal());
    }

    /**
     * Get the raw JWT token
     */
    public Optional<Jwt> getJwt() {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        if (auth instanceof JwtAuthenticationToken jwtAuth) {
            return Optional.of(jwtAuth.getToken());
        }
        return Optional.empty();
    }

    /**
     * Get the current user ID, throwing an exception if not authenticated
     */
    public String requireCurrentUserId() {
        return getCurrentUserId()
            .orElseThrow(() -> new IllegalStateException("No authenticated user"));
    }

    /**
     * Get the tenant ID, throwing an exception if not present
     */
    public String requireTenantId() {
        return getTenantId()
            .orElseThrow(() -> new IllegalStateException("No tenant ID in authentication context"));
    }
}
